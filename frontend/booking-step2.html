<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹´ì¹´ì˜¤ë§µìœ¼ë¡œ ì§€ì—­ ì„ íƒí•˜ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ì¹´ì¹´ì˜¤ ì§€ë„ API (autoload=false) -->
    <script type="text/javascript"
            src="//dapi.kakao.com/v2/maps/sdk.js?appkey=18a27bfefd7b461ecd35f7533947ff19&libraries=services,drawing&autoload=false">
    </script>
    <style>
        #map { width: 100%; height: 600px; border-radius: 0.5rem; }
        .valley-list-item { cursor: pointer; }
        .valley-list-item:hover { background-color: #f0f0f0; }
    </style>
</head>
<body class="bg-gray-100 p-8">
<div class="container mx-auto max-w-6xl bg-white p-6 rounded-lg shadow-lg">
    <header class="text-center mb-6 relative">
        <h1 class="text-3xl font-bold">ê³„ê³¡ ì˜ˆì•½í•˜ê¸°</h1>
        <p class="text-gray-600">ì§€ë„ì—ì„œ ì›í•˜ì‹œëŠ” ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”.</p>
        <!-- í™ˆìœ¼ë¡œ ë²„íŠ¼ -->
        <a href="index.html"
           class="absolute top-0 right-0 bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition">
            ğŸ  í™ˆìœ¼ë¡œ
        </a>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- ì§€ë„ ì˜ì—­ -->
        <div id="map" class="md:col-span-2"></div>

        <!-- ì„ íƒ ì •ë³´ ë° ê³„ê³¡ ëª©ë¡ -->
        <div class="bg-gray-50 p-4 rounded-lg">
            <h2 class="text-xl font-semibold mb-2">ì„ íƒ ì§€ì—­</h2>
            <p class="mb-4">
                <span id="selected-region-name" class="font-bold text-blue-600">ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</span>
            </p>
            <h3 class="text-lg font-semibold border-t pt-4">ê³„ê³¡ ëª©ë¡</h3>
            <ul id="valley-list" class="mt-2 space-y-2 h-96 overflow-y-auto"></ul>
        </div>
    </div>
</div>

<script>
const valleyData = {
    "ì„œìš¸íŠ¹ë³„ì‹œ": [
        { name: "ìš°ì´ë™ ê³„ê³¡", address: "ì„œìš¸ ê°•ë¶êµ¬ ìš°ì´ë™", lat: 37.6631, lng: 127.0123 },
        { name: "ì§„ê´€ì‚¬ ê³„ê³¡", address: "ì„œìš¸ ì€í‰êµ¬ ì§„ê´€ë™", lat: 37.6369, lng: 126.9412 }
    ],
    "ê²½ê¸°ë„": [
        { name: "ì†¡ì¶” ê³„ê³¡", address: "ê²½ê¸° ì–‘ì£¼ì‹œ ì¥í¥ë©´", lat: 37.7311, lng: 127.0345 },
        { name: "ìš©ì¶” ê³„ê³¡", address: "ê²½ê¸° ê°€í‰êµ° ê°€í‰ì", lat: 37.8683, lng: 127.5021 },
        { name: "ì–´ë¹„ ê³„ê³¡", address: "ê²½ê¸° ê°€í‰êµ° ì„¤ì•…ë©´", lat: 37.7295, lng: 127.4987 },
        { name: "ì‚¼ê³„ë¦¬ ê³„ê³¡", address: "ê²½ê¸° í¬ì²œì‹œ ì´ë™ë©´", lat: 38.0792, lng: 127.4015 }
    ],
    "ê°•ì›ë„": [
        { name: "ë¬´ë¦‰ ê³„ê³¡", address: "ê°•ì› ë™í•´ì‹œ ì‚¼í™”ë™", lat: 37.4583, lng: 129.0221 },
        { name: "í¥ì • ê³„ê³¡", address: "ê°•ì› í‰ì°½êµ° ë´‰í‰ë©´", lat: 37.6251, lng: 128.4012 }
    ]
};

const mapContainer = document.getElementById('map');
const selectedRegionNameSpan = document.getElementById('selected-region-name');
const valleyList = document.getElementById('valley-list');
let map;
let polygons = [];
let markers = [];

kakao.maps.load(() => {
    const mapOption = {
        center: new kakao.maps.LatLng(36.5, 127.8),
        level: 12
    };
    map = new kakao.maps.Map(mapContainer, mapOption);

    map.addControl(new kakao.maps.MapTypeControl(), kakao.maps.ControlPosition.TOPRIGHT);
    map.addControl(new kakao.maps.ZoomControl(), kakao.maps.ControlPosition.RIGHT);

    // --- ìˆ˜ì •ëœ ë¶€ë¶„: ë¡œì»¬ JSON íŒŒì¼ ê²½ë¡œ ìˆ˜ì • ---
    fetch('./skorea-provinces.json')
        .then(response => response.json())
        .then(geojson => {
            const areas = geojson.features.map(feature => {
                let coords = feature.geometry.coordinates;
                let paths = [];

                if (feature.geometry.type === "Polygon") {
                    paths = [coords[0].map(coord => new kakao.maps.LatLng(coord[1], coord[0]))];
                } else if (feature.geometry.type === "MultiPolygon") {
                    paths = coords.map(polygon =>
                        polygon[0].map(coord => new kakao.maps.LatLng(coord[1], coord[0]))
                    );
                }

                return { name: feature.properties.name, paths };
            });

            displayArea(areas);
        })
        .catch(error => {
            console.error('í–‰ì •êµ¬ì—­ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:', error);
        });
});

function displayArea(areaData) {
    const colors = ['#F9E2AF', '#A8D8EA', '#F1A7A7', '#B5EAD7', '#C7CEEA',
                  '#FFD1DC', '#E0BBE4', '#FFDAC1', '#D4F0F0'];
    let colorIndex = 0;
    let selectedPolygon = null;

    areaData.forEach((area) => {
        const color = colors[colorIndex % colors.length];
        colorIndex++;

        const polygon = new kakao.maps.Polygon({
            map: map,
            path: area.paths,
            strokeWeight: 2,
            strokeColor: '#004c80',
            strokeOpacity: 0.8,
            fillColor: color,
            fillOpacity: 0.7
        });
        polygons.push(polygon);

        kakao.maps.event.addListener(polygon, 'mouseover', () => {
            if (polygon !== selectedPolygon) polygon.setOptions({ fillOpacity: 1 });
            map.setCursor('pointer');
        });

        kakao.maps.event.addListener(polygon, 'mouseout', () => {
            if (polygon !== selectedPolygon) polygon.setOptions({ fillOpacity: 0.7 });
            map.setCursor('');
        });

        kakao.maps.event.addListener(polygon, 'click', () => {
            if (selectedPolygon) {
                selectedPolygon.setOptions({ fillOpacity: 0.7, strokeColor: '#004c80' });
            }
            polygon.setOptions({ fillOpacity: 1, strokeColor: '#ff0000' });
            selectedPolygon = polygon;
            updateValleyList(area.name);
        });
    });
}

function updateValleyList(regionName) {
    selectedRegionNameSpan.textContent = regionName;
    valleyList.innerHTML = '';
    removeMarkers();

    const valleys = valleyData[regionName];
    if (valleys && valleys.length > 0) {
        const bounds = new kakao.maps.LatLngBounds();

        valleys.forEach(valley => {
            const li = document.createElement('li');
            li.className = 'p-2 rounded valley-list-item';
            li.textContent = valley.name;

            const markerPosition = new kakao.maps.LatLng(valley.lat, valley.lng);
            bounds.extend(markerPosition);

            li.onclick = () => { map.panTo(markerPosition); };
            valleyList.appendChild(li);

            const marker = new kakao.maps.Marker({ position: markerPosition });
            marker.setMap(map);
            markers.push(marker);

            const infowindow = new kakao.maps.InfoWindow({
                content: `<div style="padding:5px;font-size:12px;">${valley.name}</div>`
            });
            kakao.maps.event.addListener(marker, 'mouseover', () => infowindow.open(map, marker));
            kakao.maps.event.addListener(marker, 'mouseout', () => infowindow.close());
        });

        map.setBounds(bounds);
    } else {
        valleyList.innerHTML = '<li class="text-gray-500">ë“±ë¡ëœ ê³„ê³¡ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
    }
}

function removeMarkers() {
    for (let i = 0; i < markers.length; i++) {
        markers[i].setMap(null);
    }
    markers = [];
}
</script>
</body>
</html>
