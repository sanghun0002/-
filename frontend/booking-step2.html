<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>카카오맵 지역 선택</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=18a27bfefd7b461ecd35f7533947ff19&libraries=services"></script>
  <style>
    #map { width: 100%; height: 600px; border-radius: 0.5rem; }
    .valley-list-item { cursor: pointer; }
    .valley-list-item:hover { background-color: #f0f0f0; }
  </style>
</head>
<body class="bg-gray-100 p-8">

<div class="container mx-auto max-w-6xl bg-white p-6 rounded-lg shadow-lg">
  <header class="text-center mb-6">
    <h1 class="text-3xl font-bold">계곡 예약하기</h1>
    <p class="text-gray-600">지도에서 원하시는 지역을 선택하세요.</p>
  </header>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- 지도 영역 -->
    <div id="map" class="md:col-span-2"></div>

    <!-- 선택 정보 및 계곡 목록 -->
    <div class="bg-gray-50 p-4 rounded-lg">
      <h2 class="text-xl font-semibold mb-2">선택 지역</h2>
      <p class="mb-4"><span id="selected-region-name" class="font-bold text-blue-600">지역을 선택해주세요.</span></p>
      <h3 class="text-lg font-semibold border-t pt-4">계곡 목록</h3>
      <ul id="valley-list" class="mt-2 space-y-2 h-96 overflow-y-auto"></ul>
    </div>
  </div>
</div>

<script>
  // --- 계곡 데이터 ---
  const valleyData = {
    "서울특별시": [
      { name: "우이동 계곡", address: "서울 강북구 우이동", lat: 37.6631, lng: 127.0123 },
      { name: "진관사 계곡", address: "서울 은평구 진관동", lat: 37.6369, lng: 126.9412 }
    ],
    "경기도": [
      { name: "송추 계곡", address: "경기 양주시 장흥면", lat: 37.7311, lng: 127.0345 },
      { name: "용추 계곡", address: "경기 가평군 가평읍", lat: 37.8683, lng: 127.5021 },
      { name: "어비 계곡", address: "경기 가평군 설악면", lat: 37.7295, lng: 127.4987 }
    ],
    "강원도": [
      { name: "무릉 계곡", address: "강원 동해시 삼화동", lat: 37.4583, lng: 129.0221 },
      { name: "흥정 계곡", address: "강원 평창군 봉평면", lat: 37.6251, lng: 128.4012 }
    ]
  };

  let map, polygons = [], markers = [];

  const mapContainer = document.getElementById('map');
  const selectedRegionNameSpan = document.getElementById('selected-region-name');
  const valleyList = document.getElementById('valley-list');

  kakao.maps.load(() => {
    map = new kakao.maps.Map(mapContainer, {
      center: new kakao.maps.LatLng(36.5, 127.8), // 대한민국 중심
      level: 13
    });

    // 지도 컨트롤
    map.addControl(new kakao.maps.MapTypeControl(), kakao.maps.ControlPosition.TOPRIGHT);
    map.addControl(new kakao.maps.ZoomControl(), kakao.maps.ControlPosition.RIGHT);

    // 행정구역 GeoJSON 불러오기
    fetch('https://raw.githubusercontent.com/southkorea/southkorea-maps/master/kostat/2013/json/skorea-provinces-2013-geo.json')
      .then(res => res.json())
      .then(geojson => {
        const areas = [];
        geojson.features.forEach(feature => {
          const coords = feature.geometry.coordinates;
          const name = feature.properties.name;

          if (feature.geometry.type === "Polygon") {
            const path = coords[0].map(c => new kakao.maps.LatLng(c[1], c[0]));
            areas.push({ name, path });
          } else if (feature.geometry.type === "MultiPolygon") {
            coords.forEach(polygon => {
              const path = polygon[0].map(c => new kakao.maps.LatLng(c[1], c[0]));
              areas.push({ name, path });
            });
          }
        });
        displayArea(areas);
      })
      .catch(err => console.error(err));
  });

  function displayArea(areaData) {
    const colors = ['#F9E2AF', '#A8D8EA', '#F1A7A7', '#B5EAD7', '#C7CEEA'];
    let selectedPolygon = null;

    areaData.forEach((area, idx) => {
      const polygon = new kakao.maps.Polygon({
        map,
        path: area.path,
        strokeWeight: 2,
        strokeColor: '#004c80',
        strokeOpacity: 0.8,
        fillColor: colors[idx % colors.length],
        fillOpacity: 0.6
      });
      polygons.push(polygon);

      // 마우스 이벤트
      kakao.maps.event.addListener(polygon, 'mouseover', () => {
        if (polygon !== selectedPolygon) polygon.setOptions({ fillOpacity: 0.9 });
      });
      kakao.maps.event.addListener(polygon, 'mouseout', () => {
        if (polygon !== selectedPolygon) polygon.setOptions({ fillOpacity: 0.6 });
      });

      kakao.maps.event.addListener(polygon, 'click', () => {
        if (selectedPolygon) selectedPolygon.setOptions({ strokeColor: '#004c80', fillOpacity: 0.6 });
        polygon.setOptions({ strokeColor: '#ff0000', fillOpacity: 0.9 });
        selectedPolygon = polygon;

        updateValleyList(area.name);
      });
    });
  }

  function updateValleyList(regionName) {
    selectedRegionNameSpan.textContent = regionName;
    valleyList.innerHTML = '';
    removeMarkers();

    const valleys = valleyData[regionName];
    if (valleys && valleys.length > 0) {
      const bounds = new kakao.maps.LatLngBounds();

      valleys.forEach(valley => {
        const li = document.createElement('li');
        li.className = 'p-2 rounded valley-list-item';
        li.textContent = valley.name;

        const markerPosition = new kakao.maps.LatLng(valley.lat, valley.lng);
        bounds.extend(markerPosition);

        li.onclick = () => map.panTo(markerPosition);
        valleyList.appendChild(li);

        const marker = new kakao.maps.Marker({ position: markerPosition });
        marker.setMap(map);
        markers.push(marker);

        const infowindow = new kakao.maps.InfoWindow({
          content: `<div style="padding:5px;font-size:12px;">${valley.name}</div>`
        });
        kakao.maps.event.addListener(marker, 'mouseover', () => infowindow.open(map, marker));
        kakao.maps.event.addListener(marker, 'mouseout', () => infowindow.close());
      });

      map.setBounds(bounds);
    } else {
      valleyList.innerHTML = '<li class="text-gray-500">등록된 계곡이 없습니다.</li>';
    }
  }

  function removeMarkers() {
    markers.forEach(m => m.setMap(null));
    markers = [];
  }
</script>
</body>
</html>
